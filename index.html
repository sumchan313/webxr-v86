<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Babylon.js AR + Non-Immersive Grabbing</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; }
    canvas { width: 100%; height: 100%; display: block; }
    button {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 10;
      padding: 10px 20px;
      font-size: 16px;
      background: pink;
      color: black;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button id="enterAR">Enter AR</button>
  <canvas id="renderCanvas"></canvas>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
  <script>
    const canvas = document.getElementById('renderCanvas');
    const engine = new BABYLON.Engine(canvas, true);
    let scene, xrHelper, grabbedMesh = null;

    const createScene = async () => {
      scene = new BABYLON.Scene(engine);
      scene.clearColor = new BABYLON.Color4(0, 0, 0, 0);

      const camera = new BABYLON.ArcRotateCamera("camera", Math.PI / 2, Math.PI / 2.5, 2, BABYLON.Vector3.Zero(), scene);
      camera.attachControl(canvas, true);

      const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
      light.intensity = 1;

      const cube = BABYLON.MeshBuilder.CreateBox("cube", { size: 0.2 }, scene);
      cube.position = new BABYLON.Vector3(0, 1.5, 0);
      cube.material = new BABYLON.StandardMaterial("mat", scene);
      cube.material.emissiveColor = new BABYLON.Color3(1, 0.4, 0.6);

      return scene;
    };
        createScene().then(createdScene => {
      scene = createdScene;

      document.getElementById('enterAR').addEventListener('click', async () => {
        xrHelper = await scene.createDefaultXRExperienceAsync({
          uiOptions: { sessionMode: 'immersive-ar' },
          optionalFeatures: ['hit-test', 'hand-tracking']
        });

        const cube = scene.getMeshByName("cube");

        xrHelper.input.onControllerAddedObservable.add(controller => {
          controller.onMotionControllerInitObservable.add(motionController => {
            const grabComponent = motionController.getComponent("grasp");
            if (grabComponent) {
              grabComponent.onButtonStateChangedObservable.add(() => {
                if (grabComponent.pressed) {
                  const controllerPos = controller.grip ? controller.grip.position : controller.pointer.position;
                  if (BABYLON.Vector3.Distance(controllerPos, cube.position) < 0.3) {
                    grabbedMesh = cube;
                    grabbedMesh.setParent(controller.grip || controller.pointer);
                    grabbedMesh.material.emissiveColor = new BABYLON.Color3(1, 1, 0); // highlight
                  }
                } else {
                  if (grabbedMesh) {
                    grabbedMesh.setParent(null);
                    grabbedMesh.material.emissiveColor = new BABYLON.Color3(1, 0.4, 0.6); // reset
                    grabbedMesh = null;
                  }
                }
              });
            }
          });
        });
      });

      engine.runRenderLoop(() => {
        scene.render();
      });
    });

    window.addEventListener("resize", () => {
      engine.resize();
    });
  </script>
</body>
</html>
